const realtime={lastEventId:0,isOpen:!1,reconnect:function(){return realtime.connect(realtime.handler)},connect:function(e){if(!e||"function"!=typeof e)throw new TypeError("Callback handler must be provided");realtime.handler=e;let t=_xmlHttpGet();return t.withCredentials=!0,t.onreadystatechange=function(){if(4!==t.readyState)return;let n=JSON.parse(t.responseText);return n.url?(e({event:"connected"}),function t(n,s,a){realtime.isOpen=!0;let i=_xmlHttpGet();return i.onreadystatechange=function(){if(4!==i.readyState)return;let r=JSON.parse(i.responseText);return"timeout"===r.event?(realtime.isOpen=!1,t(n,s,a)):(realtime.lastEventId=(r.last_event_id||0)+1,r.error?(realtime.isOpen=!1,realtime.connect(a)):(e(r,a),t(n,realtime.lastEventId,a)))},i.onerror=function(){return realtime.isOpen=!1,e({event:"connection_failure"},a)},i.open("GET",n+"&last_event_id="+s),i.send()}(n.url,n.last_event_id,e)):e({event:"connection_failure"})},t.open("GET","https://lp.yunnet.ru/?mode=get"),t.send()}},messages={createChat:function(e){return new Promise(function(t,n){if(e.title.isEmpty()||e.members.length<2)return n();if(!settings.users.current)return n(new ChatError("Unauthorized user."));let s=new FormData;s.append("action","chat_create"),s.append("title",e.title),s.append("members",e.members.join()),s.append("photo",e.photo);for(let t in e.permissions)s.append("permission_"+t,e.permissions[t]);return ui.Request({url:"/messages",method:"POST",data:s,success:function(e){if((e=JSON.parse(e)).error){let t=new ChatError("Chat creation failed.");return t.errorCode=e.error,n(t)}return t(e.response)}})})},elements:{message:function(e,t=!1){let n,s=document.createElement("div");if(s.id=e.id,e.event){let t=document.createElement("div");s.appendChild(t),t.style.color="var(--unt-events-textcolor, black)",s.style.padding="15px",t.innerHTML="...",settings.users.get(e.from_id).then(function(n){t.innerHTML=messages.utils.getEventString(e.event.action||e.event.type,n,null,!1),e.event.to_id?settings.users.get(e.event.to_id).then(function(s){t.innerHTML=messages.utils.getEventString(e.event.action||e.event.type,n,s,!1)}).catch(function(e){t.innerHTML=t.innerHTML.replace("%when%",settings.lang.getValue("deleted_account"))}):t.innerHTML=messages.utils.getEventString(e.event.action||e.event.type,n,null,!1)})}else{let t;s.classList.add("valign-wrapper"),e.from_id===settings.users.current.user_id&&(t=document.createElement("div"),s.appendChild(t),t.style.position="sticky",t.style.left="100%",t.classList.add("valign-wrapper"));let a=document.createElement("div"),i=document.createElement("div"),r=document.createElement("div");if(e.is_edited&&(r.innerHTML=unt.Icon.EDIT,r.style.marginBottom="16px",r.style.marginTop="auto",r.getElementsByTagName("svg")[0].width.baseVal.value=12,r.getElementsByTagName("svg")[0].height.baseVal.value=12,e.from_id===settings.users.current.user_id&&(t.appendChild(r),r.style.marginRight="3px")),i.style.marginBottom="20px",i.style.marginTop="auto",e.from_id===settings.users.current.user_id)t.appendChild(i),a.classList=["from_me from-me msg"],t.appendChild(a),i.style.textAlign="-webkit-right",i.style.marginRight="10px";else{a.classList=["from_another from-them msg"],i.style.marginLeft="10px";let t=document.createElement("a");s.appendChild(t);let n=document.createElement("img");n.width=n.height=32,n.classList=["circle"],t.style.marginRight="10px",t.style.marginBottom="auto",t.appendChild(n),s.appendChild(a),t.href="/"+(e.from_id>0?"id"+e.from_id:"bot"+-1*e.from_id),t.setAttribute("target","_blank"),settings.users.get(e.from_id).then(function(e){n.src=e.photo_url,n.alt=e.name||e.first_name+" "+e.last_name}).catch(function(e){n.src="https://dev.yunnet.ru/images/default.png",n.alt=""})}let l=document.createElement("small");if(i.appendChild(l),n=document.createElement("small"),l.appendChild(n),e.text&&!e.text.isEmpty()){let t=document.createElement("div");a.appendChild(t),t.innerHTML=nl2br(htmlspecialchars(e.text)).linkify()}if(e.attachments.length>0){let t=pages.elements.attachmentsGroup(e.attachments);a.appendChild(t)}if(e.fwd.length>0){let t=messages.elements.fwd(e.fwd);a.appendChild(t)}e.from_id!==settings.users.current.user_id&&s.appendChild(i),e.is_edited&&e.from_id!==settings.users.current.user_id&&(s.appendChild(r),r.style.marginLeft="3px")}return s.setSending=function(t){return s.isSending=t,s.sendError=!1,t?n&&(n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 57 57" stroke="#000"><g fill="none" fill-rule="evenodd"><g transform="translate(1 1)" stroke-width="2"><circle cx="5" cy="50" r="5"><animate attributeName="cy" begin="0s" dur="2.2s" values="50;5;50;50" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="cx" begin="0s" dur="2.2s" values="5;27;49;5" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="27" cy="5" r="5"><animate attributeName="cy" begin="0s" dur="2.2s" from="5" to="5" values="5;50;50;5" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="cx" begin="0s" dur="2.2s" from="27" to="27" values="27;49;5;27" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="49" cy="50" r="5"><animate attributeName="cy" begin="0s" dur="2.2s" values="50;50;5;50" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="cx" from="49" to="49" begin="0s" dur="2.2s" values="49;5;27;49" calcMode="linear" repeatCount="indefinite"></animate></circle></g></g></svg>'):n&&(n.innerText=pages.parsers.time(e.time,!0)),s},s.setError=function(e){let t=s.getElementsByTagName("small")[1];return t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="red" height="18" viewBox="0 0 24 24" width="18"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',s.isSending=!1,s.sendError=!0,e&&(t.getElementsByTagName("svg")[0].onclick=function(t){return t.preventDefault(),e(t)}),s},s.setSending(t)},fwd:function(e){let t=document.createElement("blockquote");return e.forEach(function(e){let n=document.createElement("a");t.appendChild(n),n.classList.add("valign-wrapper"),n.classList.add("alink-name"),n.href=e.from_id>0?"/id"+e.from_id:"/bot"+-1*e.from_id,n.setAttribute("target","_blank");let s=document.createElement("img");n.appendChild(s),s.width=s.height=24,s.classList.add("circle");let a=document.createElement("div");if(n.appendChild(a),n.style.paddingBottom="5px",a.style.marginLeft="5px",a.style.fontSize="85%",settings.users.get(e.from_id).then(function(e){a.innerText=e.name||e.first_name+" "+e.last_name,s.src=e.photo_url}).catch(function(e){a.innerText=settings.lang.getValue("deleted_account"),s.src="https://dev.yunnet.ru/images/default.png"}),!e.text.isEmpty()){let n=document.createElement("div");n.style.fontSize="95%",n.innerHTML=nl2br(htmlspecialchars(e.text)).linkify(),t.appendChild(n)}if(e.attachments.length>0){let n=pages.elements.attachmentsGroup(e.attachments);t.appendChild(n)}e.fwd.length>0&&t.appendChild(messages.elements.fwd(e.fwd))}),t}},utils:{getChatInfoByLink:function(e){return new Promise(function(t,n){let s=new FormData;return s.append("action","get_chat_info_by_link"),s.append("link_query",e),ui.Request({data:s,url:"/messages",method:"POST",success:function(e){if((e=JSON.parse(e)).error){let t=new TypeError("Unable to show chat info");return e.chat_id&&(t.chatId=e.chat_id),t.errorCode=e.error,n(t)}return t(e)}})})},joinByLink:function(e){return new Promise(function(t,n){let s=new FormData;return s.append("action","join_to_chat_by_link"),s.append("link_query",e),ui.Request({data:s,url:"/messages",method:"POST",success:function(e){if((e=JSON.parse(e)).error){let t=new TypeError("Unable to show chat info");return e.chat_id&&(t.chatId=e.chat_id),t.errorCode=e.error,n(t)}return t(e.response)}})})},getEventString:function(e,t,n=null,s=!1){let a="";switch(e){case"mute_user":a=settings.lang.getValue("mute_user").replace("(а)",2===t.gender?"а":""),n&&!s&&(a=a.replace("%when%",'<a style="color: var(--unt-event-names-color, gray) !important" href="/'+(n.name?"bot"+n.bot_id:"id"+n.user_id)+'" target="_blank" style="font-weight: bold">'+htmlspecialchars(n.name||n.name_cases.first_name.dat+" "+n.name_cases.last_name.dat)+"</a>")),n&&s&&(a=a.replace("%when%",htmlspecialchars(n.name||n.name_cases.first_name.dat+" "+n.name_cases.last_name.dat)));break;case"unmute_user":a=settings.lang.getValue("unmute_user").replace("(а)",2===t.gender?"а":""),n&&!s&&(a=a.replace("%when%",'<a style="color: var(--unt-event-names-color, gray) !important" href="/'+(n.name?"bot"+n.bot_id:"id"+n.user_id)+'" target="_blank" style="font-weight: bold">'+htmlspecialchars(n.name||n.name_cases.first_name.dat+" "+n.name_cases.last_name.dat)+"</a>")),n&&s&&(a=a.replace("%when%",htmlspecialchars(n.name||n.name_cases.first_name.dat+" "+n.name_cases.last_name.dat)));break;case"returned_to_chat":a=settings.lang.getValue("returned_to_chat").replace("лся(-ась)",2===t.gender?"лась":"лся");break;case"join_by_link":a=settings.lang.getValue("join_by_link").replace("лся(-ась)",2===t.gender?"лась":"лся");break;case"leaved_chat":a=settings.lang.getValue("leaved_the_chat").replace("(а)",2===t.gender?"а":"");break;case"updated_photo":a=settings.lang.getValue("updated_photo").replace("(а)",2===t.gender?"а":"");break;case"deleted_photo":a=settings.lang.getValue("deleted_photo").replace("(а)",2===t.gender?"а":"");break;case"kicked_user":a=settings.lang.getValue("kicked_user").replace("(а)",2===t.gender?"а":""),n&&!s&&(a=a.replace("%when%",'<a style="color: var(--unt-event-names-color, gray) !important" href="/'+(n.name?"bot"+n.bot_id:"id"+n.user_id)+'" target="_blank" style="font-weight: bold">'+htmlspecialchars(n.name||n.name_cases.first_name.acc+" "+n.name_cases.last_name.acc)+"</a>")),n&&s&&(a=a.replace("%when%",htmlspecialchars(n.name||n.name_cases.first_name.acc+" "+n.name_cases.last_name.acc)));break;case"invited_user":a=settings.lang.getValue("invited_user").replace("(а)",2===t.gender?"а":""),n&&!s&&(a=a.replace("%when%",'<a style="color: var(--unt-event-names-color, gray) !important" href="/'+(n.name?"bot"+n.bot_id:"id"+n.user_id)+'" target="_blank" style="font-weight: bold">'+htmlspecialchars(n.name||n.name_cases.first_name.acc+" "+n.name_cases.last_name.acc)+"</a>")),n&&s&&(a=a.replace("%when%",htmlspecialchars(n.name||n.name_cases.first_name.acc+" "+n.name_cases.last_name.acc)));break;case"change_title":a=settings.lang.getValue("changed_title").replace("(а)",2===t.gender?"а":"");break;case"chat_create":a=settings.lang.getValue("chat_create")}return(a=s?a.replace("%who%",t.name||t.first_name+" "+t.last_name):a.replace("%who%",'<a style="color: var(--unt-event-names-color, gray) !important" href="/'+(t.name?"bot"+t.bot_id:"id"+t.user_id)+'" target="_blank" style="font-weight: bold">'+htmlspecialchars(t.name||t.first_name+" "+t.last_name)+"</a>")).replace("%username%","%who%")},getChatInstance:function(e,t){return messages.cache[e]||0===e?messages.cache[e]instanceof Chat?messages.cache[e]:null:new Chat(e,t)},toDefaultObject:function(e){let t={attachments:[],fwd:[],from_id:0,id:0,text:"",time:0};return e.message?(t.from_id=e.message.from_id,t.time=e.message.time,t.fwd=e.message.fwd,t.attachments=e.message.attachments,t.text=e.message.text,t.id=e.message.id,e.message.is_edited&&(t.is_edited=!0),e.message.action&&(t.event=e.message.action)):(t.from_id=e.from_id,t.time=e.time,t.fwd=e.fwd,t.attachments=e.attachments,t.text=e.text,t.id=e.id,e.is_edited&&(t.is_edited=!0),e.event&&(t.event=e.event)),e.peer_id&&(t.peer_id=e.peer_id),e.bot_peer_id&&(t.bot_peer_id=e.bot_peer_id),t},getPreviewString:function(e){return new Promise(function(t,n){let s="",a=settings.users.current.user_id;if(e.event)settings.users.get(e.from_id).then(function(n){if(!e.event.to_id)return s=messages.utils.getEventString(e.event.action||e.event.type,n,null,!0),t(s);settings.users.get(e.event.to_id).then(function(a){return s=messages.utils.getEventString(e.event.action||e.event.type,n,a,!0),t(s)}).catch(function(a){return s=messages.utils.getEventString(e.event.action||e.event.type,n,null,!0),t(s)})}).catch(function(e){return t(s="")});else{if(a===e.from_id)return s+=settings.lang.getValue("you")+":",e.text&&(s+=" "+e.text),e.fwd.length>0?s+=" ["+e.fwd.length+" FWD]":e.attachments.length>0&&(s+=" ["+e.attachments.length+" ATT]"),t(s);settings.users.get(e.from_id).then(function(n){return s+=("user"===n.account_type?n.first_name:n.name)+":",e.text&&(s+=" "+e.text),e.fwd.length>0?s+=" ["+e.fwd.length+" FWD]":e.attachments.length>0&&(s+=" ["+e.attachments.length+" ATT]"),t(s)}).catch(function(n){return s+="O:",e.text&&(s+=" "+e.text),e.fwd.length>0?s+=" ["+e.fwd.length+" FWD]":e.attachments.length>0&&(s+=" ["+e.attachments.length+" ATT]"),t(s)})}})}},cache:{},get:function(e=0,t=30,n=!1){return new Promise(function(s,a){let i=new FormData;return i.append("action","get_chats"),i.append("offset",Number(e)),i.append("count",Number(t)||30),i.append("only_chats",Number(n)),ui.Request({url:"/messages",method:"POST",data:i,success:function(e){if((e=JSON.parse(e)).error)return a(new TypeError("Chats fetching error"));for(let t=0;t<e.length;t++){let n=e[t].chat_info.is_bot_chat?"b"+-1*e[t].bot_peer_id:e[t].peer_id;messages.cache[n]=messages.utils.getChatInstance(n,e[t])}return s(e)}})})},getChatByPeer:function(e){return new Promise(function(t,n){messages.utils.getChatInstance(e,null).getInfo().then(function(e){return t(e)}).catch(function(e){return n(e)})})}},poll={actions:{create:function(e="",t=[],n=!1,s=!1){return new Promise(function(a,i){let r=new FormData;if(e.toString().isEmpty())return i(new TypeError("Unable to create poll: Title is empty."));let l=[];for(let e=0;e<t.length&&!(e>=10);e++)l.push(t[e].toString());return r.append("poll_title",e),r.append("poll_anonymous",Number(n)||0),r.append("poll_multi_selection",Number(s)||0),r.append("poll_answers_list",JSON.stringify(l)),ui.Request({url:"/upload?type=poll&action=get",method:"POST",data:r,success:function(e){return(e=JSON.parse(e)).error?i(new TypeError("Unable to create the poll")):a(e)}})})}},pinned:function(e){let t=e.getElementsByTagName("div");for(let e=0;e<t.length;e++)if(t[e].getAttribute("attachment").startsWith("poll"))return!0;return!1},creator:function(e){const t={title:"",answers:[],anonymous:!1,multipleSelection:!1,inProcess:!1};let n=document.createElement("div");n.classList.add("modal"),n.classList.add("hidesc"),n.classList.add("bottom-sheet"),n.style.maxHeight="unset",n.style.height="100%",n.id="pollCreator";let s=document.createElement("div");s.classList.add("modal-content"),n.appendChild(s);let a=document.createElement("div");s.appendChild(a),a.classList.add("valign-wrapper"),a.style.width="100%";let i=document.createElement("div");a.appendChild(i),i.style.width="100%",i.innerText=settings.lang.getValue("create_poll");let r,l=document.createElement("div");l.style.cursor="pointer",l.style.marginTop="5px",a.appendChild(l),l.innerHTML=unt.Icon.CLOSE,l.addEventListener("click",function(){if(!t.inProcess)return n.getInstance().close()}),n.show=function(){return document.getElementById(n.id)?r=unt.Modal.getInstance(n):(pages.elements.menuBody().getCurrent().appendChild(n),r=unt.Modal.init(n,{dismissible:!1,onCloseEnd:function(){return n.remove()}})),r.open()},n.getInstance=function(){return r},n.createAnswer=function(e=!0){if(t.answers.length>=10)return;let s=document.createElement("div");s.classList.add("valign-wrapper");let a=pages.elements.createInputField(settings.lang.getValue("answer_title")).maxLength(128);a.style.width="100%",s.appendChild(a),c.appendChild(s);let i=document.createElement("div");i.style.cursor="pointer",i.style.marginLeft="10px",i.innerHTML=unt.Icon.CLOSE,s.appendChild(i);let r={id:t.answers.length+1,title:a.getValue()};return a.getInput().addEventListener("input",function(){r.title=a.getValue()}),e||(i.style.display="none"),i.addEventListener("click",function(){if(!t.inProcess){for(let e=0;e<t.answers.length;e++)if(t.answers[e].id===r.id){t.answers.splice(e,1),s.remove();break}t.answers.length>=10?g.classList.add("disabled"):g.classList.remove("disabled"),!o.getValue().isEmpty()&&t.answers.length>=2?h.classList.remove("disabled"):h.classList.add("disabled")}}),t.answers.push(r),n};let o=pages.elements.createInputField(settings.lang.getValue("poll_title")).maxLength(64);s.appendChild(o),o.getInput().addEventListener("input",function(e){if(t.inProcess)return e.preventDefault();t.title=o.getValue(),!o.getValue().isEmpty()&&t.answers.length>=2?h.classList.remove("disabled"):h.classList.add("disabled")});let c=document.createElement("div");c.classList.add("card"),c.classList.add("hidesc"),s.appendChild(c),c.style.maxHeight="250px",c.style.overflow="auto",c.style.paddingLeft="10px",c.style.paddingRight="10px";let d=document.createElement("div");s.appendChild(d),d.style.width="100%",d.style.textAlign="end";let g=document.createElement("a");g.classList.add("btn"),g.classList.add("unselectable"),d.appendChild(g),g.innerText=settings.lang.getValue("create_answer"),g.addEventListener("click",function(){t.inProcess||(n.createAnswer(),t.answers.length>=10?g.classList.add("disabled"):g.classList.remove("disabled"),!o.getValue().isEmpty()&&t.answers.length>=2?h.classList.remove("disabled"):h.classList.add("disabled"))});let u=pages.elements.createChecker(settings.lang.getValue("anonymous_poll"),function(){t.anonymous=u.checked()});s.appendChild(u);let m=pages.elements.createChecker(settings.lang.getValue("multi_selection"),function(){t.multipleSelection=m.checked()});s.appendChild(m);let p=document.createElement("div");p.classList.add("modal-footer"),n.appendChild(p);let h=document.createElement("a");return h.classList=["btn btn-flat unselectable waves-effect waves-light disabled"],h.innerText=settings.lang.getValue("continue"),p.appendChild(h),n.getPoll=function(){},h.onclick=function(){h.classList.add("disabled"),h.innerText=settings.lang.getValue("loading"),t.inProcess=!0;let s=[];t.answers.forEach(function(e){s.push(e.title)}),poll.actions.create(t.title,s,t.anonymous,t.multipleSelection).then(function(s){if(t.inProcess=!1,h.innerText=settings.lang.getValue("continue"),h.classList.remove("disabled"),n.getInstance().close(),"function"==typeof e)return e(s,n)}).catch(function(e){unt.toast({html:settings.lang.getValue("upload_error")}),t.inProcess=!1,h.innerText=settings.lang.getValue("continue"),h.classList.remove("disabled")})},n}};window.addEventListener("authCompleted",function(){pages.messages.typers={},realtime.connect.pending={},realtime.checker=setInterval(function(){if(settings.users.current||clearInterval(realtime.checker),!realtime.isOpen&&settings.users.current)return console.log("[!] Restoring LP connection..."),realtime.reconnect()},3e5),realtime.connect(function(e,t){console.log(e);let n=e.event,s=new URLParser(window.location.href).parse();if("connection_failure"===n){if(!settings.users.current)return;console.log("[!] Reconnecting after 3 sec..."),setTimeout(function(){console.log("[+] Connecting to LP..."),realtime.connect(t),console.log("[ok] Done.")},3e3)}if("cleared_chat"===n){let t=e.peer_id||"b"+e.bot_peer_id,n=document.getElementById("messages_list");if(n){let e=document.getElementById("dial_"+t);if(e)return e.remove(),messages.get(30,1).then(function(e){if(e.length>0){let t=pages.elements.messages.dialog(e[0],{onContext:function(e,t,n){let s=pages.elements.contextMenu([[settings.lang.getValue("clear_messages_history"),function(e){return pages.elements.confirm("",settings.lang.getValue("chat_clear_confirmation"),function(e){if(e)return messages.utils.getChatInstance(chat.peer_id||"b"+-1*chat.bot_peer_id).clearHistory().catch(function(e){return unt.toast({html:settings.lang.getValue("upload_error")})})})}]]);if(s.open)return s.open(t)}},null);n.appendChild(t)}}).catch(function(e){})}let s=document.getElementById("messages_"+t);s&&(s.innerHTML="")}if("new_message"===n||"edit_message"===n){let t=pages.elements.menuBody(),a=e.peer_id||"b"+-1*e.bot_peer_id,i=messages.utils.toDefaultObject(e),r=messages.utils.getChatInstance(a),l=e.message.id,o=messages.utils.getChatInstance(a);o.getInfo().then(function(c){if(c.metadata.unread_count+=1,settings.getCounters.current&&c.metadata.is_read_by_me&&(settings.getCounters.current.messages+=1,pages.elements.setupCounters(settings.getCounters.current)),c.metadata.is_read_by_me=!1,i.event&&i.event.type){let e=i.event.type,t=i.event.to_id,n=document.getElementsByClassName("chat-photo")[0],r=document.getElementsByClassName("chat-title")[0];if("change_title"===e){let e=i.event.new_title;c.chat_info.data.title=e,r&&(r.innerText=e)}if("updated_photo"===e){console.log(i.event);let e=i.event.new_photo_url;c.chat_info.data.photo_url=e,n&&(n.src=e)}if("deleted_photo"===e){let e="https://dev.yunnet.ru/images/default.png";c.chat_info.data.photo_url=e,n&&(n.src=e)}if("mute_user"===e){try{for(let e=0;e<o.cachedMembers.length;e++)if(o.cachedMembers[e].user_id===t||-1*o.cachedMembers[e].bot_id===t){o.cachedMembers[e].chat_info.is_muted=!0;break}}catch(e){}t===settings.users.current.user_id&&(c.metadata.permissions.is_muted=!0,String(s.s)===String(a)&&document.getElementById("messagesInput")&&document.getElementById("messagesInput").setErrorMessage(settings.lang.getValue("cant_chat")))}if("unmute_user"===e){try{for(let e=0;e<o.cachedMembers.length;e++)if(o.cachedMembers[e].user_id===t||-1*o.cachedMembers[e].bot_id===t){o.cachedMembers[e].chat_info.is_muted=!1;break}}catch(e){}t===settings.users.current.user_id&&(c.metadata.permissions.is_muted=!1,String(s.s)===String(a)&&document.getElementById("messagesInput")&&document.getElementById("messagesInput").hideErrorMessage())}if("kicked_user"===e||"leaved_chat"===e){"leaved_chat"===e&&(t=settings.users.current.user_id);try{for(let e=0;e<o.cachedMembers.length;e++)if(o.cachedMembers[e].user_id===t||-1*o.cachedMembers[e].bot_id===t){o.cachedMembers.splice(e,1),document.getElementById(t)&&document.getElementById(t).remove();break}}catch(e){}t===settings.users.current.user_id&&(c.metadata.permissions.is_kicked=!0,String(s.s)===String(a)&&document.getElementById("messagesInput")&&document.getElementById("messagesInput").setErrorMessage(settings.lang.getValue("cant_chat")))}"invited_user"!==e&&"returned_to_chat"!==e||("returned_to_chat"===e&&(t=settings.users.current.user_id),settings.users.get(t).then(function(e){if(o.cachedMembers.push(e),e.chat_info={access_level:0,invited_by:1},t===settings.users.current.user_id&&(c.metadata.permissions.is_kicked=!1),String(s.s)===String(a)){document.getElementById("messagesInput")&&document.getElementById("messagesInput").hideErrorMessage();let t=pages.elements.userItem(e);document.getElementById("membersInfo")&&document.getElementById("membersInfo").appendChild(t)}}))}if(pages.messages.typers[a]||(pages.messages.typers[a]=[]),pages.messages.typers[a].splice(pages.messages.typers[a].indexOf(i.from_id),1),String(s.s)===String(a)){pages.parsers.typingText(pages.messages.typers[a],document.getElementsByClassName("typing-info")[0]);try{pages.messages.typers.length>0?(document.getElementById("typingState").style.display="",document.getElementsByClassName("members-info")[0].style.display="none"):(document.getElementsByClassName("members-info")[0].style.display="",document.getElementById("typingState").style.display="none")}catch(e){}}if(r.messagesCache.getLength()>0&&"new_message"===n&&r.messagesCache.addValue(e.message.id,i),r.messagesCache.getLength()>0&&"edit_message"===n&&(r.messagesCache[e.message.id]=i),c.last_message=i,a===s.s){let t,s=document.getElementById("messages_"+a);if(realtime.connect.pending[l]?(t=realtime.connect.pending[l],delete realtime.connect.pending[l]):((t=messages.elements.message(i)).onclick=function(e){return codes.callbacks.messageCallback(this,o,actsHeader,chatHeader,e)},"new_message"===n&&s?e.message.from_id===settings.users.current.user_id&&document.getElementById(l)||s.appendChild(t):document.getElementById(String(e.message.id))&&document.getElementById(String(e.message.id)).replaceWith(t)),"new_message"===n){if(e.message.from_id!==settings.users.current.user_id&&o.read(),s){let e=s.scrollHeight-s.clientHeight;console.log(e-s.scrollTop,t.clientHeight+100),e-s.scrollTop<t.clientHeight+100&&s.scrollTo(0,s.scrollHeight)}settings.get().push.sound&&settings.playCurrentSound()}if(o.keyboard){let e=document.getElementsByClassName("chat-keyboard-toggle")[0];o.keyboard.params.oneTime&&(o.keyboard.elements.keyboard.remove(),e.hide(),o.keyboard=null)}if(e.message.keyboard){let t=document.getElementsByClassName("chat-keyboard-toggle")[0];o.keyboard&&(o.keyboard.elements.keyboard.remove(),t.hide(),o.keyboard=null),o.keyboard={elements:{keyboard:pages.elements.buildKeyboard(e.message.keyboard.keyboard,o)},params:e.message.keyboard.params,items:e.message.keyboard.keyboard},t.show(),o.keyboard.params.autoShow&&t.getCallbackFunction()(null,t,!0)}}else{if("/messages"!==window.location.href.split(window.location.host)[1].split("?")[0])return;if(s.s)return;let e=pages.elements.messages.dialog(c,{onContext:function(e,t,n){let s=pages.elements.contextMenu([[settings.lang.getValue("clear_messages_history"),function(e){return pages.elements.confirm("",settings.lang.getValue("chat_clear_confirmation"),function(e){if(e)return messages.utils.getChatInstance(o.bot_peer_id||o.peer_id).clearHistory().catch(function(e){return unt.toast({html:settings.lang.getValue("upload_error")})})})}]]);if(s.open)return s.open(t)}});if(document.getElementById("messages_list")){if(document.getElementById("messages_list").style.display="",document.getElementById("dial_"+a)){document.getElementById("dial_"+a).remove()}document.getElementById("no_messages")&&document.getElementById("no_messages").remove()}else{let e=document.createElement("div");e.id="messages_list",t.appendChild(e)}document.getElementById("messages_list").prepend(e)}ui.bindItems()})}if("dialog_read"===n){let t=e.peer_id||"b"+-1*e.bot_peer_id;if(document.getElementById("messages_list")&&document.getElementById("dial_"+t)){let e=document.getElementById("dial_"+t);e.classList.remove("unreaded"),e.getElementsByClassName("thirdary-content")[0]&&e.getElementsByClassName("thirdary-content")[0].remove()}messages.utils.getChatInstance(t).getInfo().then(function(e){e.metadata.unread_count=0,e.metadata.is_read_by_me=!0})}if("interface_event"===n){let t=e.data?e.data.action:null;if(t&&"theme_changed"===t){load.style.display="",load_indicator.style.display="",load_text_info.innerText=settings.lang.getValue("theme_updating");let t=e.data.theme?"theme"+e.data.theme.owner_id+"_"+e.data.theme.id:null;return settings.get().theming.current_theme=t,themes.setup(t).then(function(){load.style.display="none",load_indicator.style.display="none",load_text_info.innerText=""})}}if("notification_read"===n){let t=e.data.id||0;for(let e=0;e<notifications.cache.length;e++)if(notifications.cache[e].id===t){notifications.cache.splice(e,1);break}settings.getCounters.current&&!e.data.is_hidden&&(settings.getCounters.current.notifications-=1,settings.getCounters.current.notifications<0&&(settings.getCounters.current.notifications=0),pages.elements.setupCounters(settings.getCounters.current)),document.getElementById("notifications_list")&&document.getElementById(String(t))&&(document.getElementById(String(t)).remove(),notifications.cache.length<=0&&(document.getElementById("notifications_list").style.display="none",document.getElementById("alertWindow")?document.getElementById("alertWindow").style.display="":pages.elements.menuBody().appendChild(pages.elements.alertWindow(unt.Icon.NO_NOTES,settings.lang.getValue("no_notes"),settings.lang.getValue("no_notes_text")))))}if("notification_hide"===n){let t=e.data.id||0;for(let e=0;e<notifications.cache.length;e++)if(notifications.cache[e].id===t){notifications.cache[e].is_hidden=!0;break}if(document.getElementById("notifications_list")&&document.getElementById(String(t))){let e=document.getElementById(String(t));e.getElementsByClassName("hide-loader")[0]&&(e.getElementsByClassName("hide-loader")[0].style.display="none")}settings.getCounters.current&&(settings.getCounters.current.notifications-=1,settings.getCounters.current.notifications<0&&(settings.getCounters.current.notifications=0),pages.elements.setupCounters(settings.getCounters.current))}if("new_notification"===n){let t=notifications.cache.reverse();t.push(e.notification),notifications.cache=t.reverse(),settings.getCounters.current&&(settings.getCounters.current.notifications+=1,pages.elements.setupCounters(settings.getCounters.current));let n=document.getElementById("notifications_list");if(n){document.getElementById("alertWindow")&&(document.getElementById("alertWindow").style.display="none"),n.style.display="";let t=pages.elements.notification(e.notification);n.prepend(t),ui.bindItems()}if(settings.get().push.notifications){"friendship_requested"===e.notification.type&&(settings.getCounters.current&&(settings.getCounters.current.friends+=1,pages.elements.setupCounters(settings.getCounters.current)),settings.users.get(e.notification.data.user_id).then(function(t){let n=unt.Notification(unt.Icon.GROUP,settings.lang.getValue("friends_adding"),settings.lang.getValue("want_to_add").replace("%usernick%",t.is_deleted?settings.lang.getValue("deleted_account"):'<a href="/'+(t.name?"bot"+t.bot_id:"id"+t.user_id)+'">'+(t.name||t.first_name+" "+t.last_name)+"</a>"),[[settings.lang.getValue("accept"),function(){settings.users.friends.acceptRequest(e.notification.data.user_id),n.close()}],[settings.lang.getValue("hide"),function(){settings.users.friends.hideRequest(e.notification.data.user_id),n.close()}]],{sound:settings.get().push.sound})}).catch(function(e){console.log(e)}))}}if("dialog_read"===n){if(!settings.getCounters.current)return;settings.getCounters.current.messages-=1,settings.getCounters.current.messages<0&&(settings.getCounters.current.messages=0),pages.elements.setupCounters(settings.getCounters.current)}if("request_hide"===n){if(settings.getCounters.current&&(settings.getCounters.current.friends-=1,settings.getCounters.current.friends<0&&(settings.getCounters.current.friends=0),pages.elements.setupCounters(settings.getCounters.current)),settings.users.friends.cache.subscribers)for(let t=0;t<settings.users.friends.cache.subscribers.length;t++){if(settings.users.friends.cache.subscribers[t].user_id===e.user_id){settings.users.friends.cache.subscribers[t].friend_state.is_hidden=!0;break}}if("/friends"!==window.location.href.split(window.location.host)[1].split("?")[0])return;let t=document.getElementById(e.user_id.toString());if(!t)return;let n=t.getElementsByClassName("hide-item")[0];if(n)return n.style.display="none"}if("friendship_by_me_accepted"===n){if(settings.getCounters.current&&(settings.getCounters.current.friends-=1,settings.getCounters.current.friends<0&&(settings.getCounters.current.friends=0),pages.elements.setupCounters(settings.getCounters.current)),settings.users.friends.cache.subscribers)for(let t=0;t<settings.users.friends.cache.subscribers.length;t++){let n=settings.users.friends.cache.subscribers[t];if(n.user_id===e.user_id){settings.users.friends.cache.subscribers.splice(t,1),settings.users.friends.cache.friends.push(n);break}}if("/friends"!==window.location.href.split(window.location.host)[1].split("?")[0])return;let t=document.getElementById(e.user_id.toString());if(!t)return;let n=t.getElementsByClassName("accept-item")[0];if(n)return n.style.display="none"}if("typing"===n){let t=e.from_id,n=e.peer_id||"b"+-1*e.bot_peer_id;pages.messages.typers[n]||(pages.messages.typers[n]=[]),-1===pages.messages.typers[n].indexOf(t)&&(pages.messages.typers[n].push(t),setTimeout(function(){pages.messages.typers[n].splice(pages.messages.typers[n].indexOf(t),1),new URLParser(window.location.href).parse().s===n&&(pages.parsers.typingText(pages.messages.typers[n],document.getElementsByClassName("typing-info")[0]),pages.messages.typers.length>0?(document.getElementById("typingState").style.display="",document.getElementsByClassName("members-info")[0].style.display="none"):(document.getElementsByClassName("members-info")[0].style.display="",document.getElementById("typingState").style.display="none"))},5e3),pages.parsers.typingText(pages.messages.typers[n],document.getElementsByClassName("typing-info")[0]),s.s===n&&(pages.messages.typers[n].length>0?(document.getElementById("typingState").style.display="",document.getElementsByClassName("members-info")[0].style.display="none"):(document.getElementsByClassName("members-info")[0].style.display="",document.getElementById("typingState").style.display="none")))}})});