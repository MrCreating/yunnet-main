const management={actions:{settings:null,getSettings:function(){return new Promise(function(e,t){if(null!==management.actions.settings)return e(management.actions.settings);let n=new FormData;return n.append("action","get_project_settings"),ui.Request({url:"/dev",method:"POST",data:n,success:function(n){try{return(n=JSON.parse(n)).error?t(new Error("Settings fetch failed")):e(management.actions.settings=n)}catch(e){return t(new Error("Settings fetch failed"))}}})})},toggleProjectClose:function(){return new Promise(function(e,t){let n=new FormData;return n.append("action","toggle_project_close"),ui.Request({url:"/dev",method:"POST",data:n,success:function(n){try{return(n=JSON.parse(n)).error?t(new Error("Toggle failed")):e(management.actions.settings.closed_project=n.response)}catch(e){return t(new Error("Toggle failed"))}}})})},toggleRegisterClose:function(){return new Promise(function(e,t){let n=new FormData;return n.append("action","toggle_register_close"),ui.Request({url:"/dev",method:"POST",data:n,success:function(n){try{return(n=JSON.parse(n)).error?t(new Error("Toggle failed")):e(management.actions.settings.closed_register=n.response)}catch(e){return t(new Error("Toggle failed"))}}})})}},users:{delete:function(e){return new Promise(function(t,n){let s=new FormData;return s.append("action","delete_user"),s.append("user_id",Number(e)||0),ui.Request({url:"/dev",method:"POST",data:s,success:function(e){try{return(e=JSON.parse(e)).error?n(new Error("Deletion failed")):t(Boolean(e.success))}catch(e){return n(new Error("Deletion failed"))}}})})},actions:{edit:function(e,t){return new Promise(function(n,s){let r=["first_name","last_name","screen_name","photo"],a=new FormData;a.append("action","edit_user"),a.append("user_id",Number(e)||0);for(let e in t)-1!==r.indexOf(e)&&a.append(e,t[e]||"");return ui.Request({url:"/dev",data:a,method:"POST",success:function(e){try{if((e=JSON.parse(e)).error){let t=new Error("Edit failed");return e.message&&(t.errorMessage=e.message),s(t)}return n(e)}catch(e){return s(new Error("Edit failed"))}}})})},banUser:function(e){return new Promise(function(t,n){let s=new FormData;return s.append("action","toggle_ban_state"),s.append("user_id",Number(e)||0),ui.Request({url:"/dev",method:"POST",data:s,success:function(e){try{return(e=JSON.parse(e)).error?n(new TypeError("Unable to change ban mode.")):t(e.state)}catch(e){return n(new TypeError("Unable to change ban mode."))}}})})},toggleVerification:function(e){return new Promise(function(t,n){let s=new FormData;return s.append("action","toggle_verification_state"),s.append("user_id",Number(e)||0),ui.Request({url:"/dev",method:"POST",data:s,success:function(e){try{return(e=JSON.parse(e)).error?n(new TypeError("Unable to change verification mode.")):t(e.state)}catch(e){return n(new TypeError("Unable to change verification mode."))}}})})},toggleOnlineShow:function(e){return new Promise(function(t,n){let s=new FormData;return s.append("action","toggle_online_show_state"),s.append("user_id",Number(e)||0),ui.Request({url:"/dev",method:"POST",data:s,success:function(e){try{return(e=JSON.parse(e)).error?n(new TypeError("Unable to change online show mode.")):t(e.state)}catch(e){return n(new TypeError("Unable to change online show mode."))}}})})}}},show:function(e){if(!settings.users.current)return pages.unauth.authPage();if(settings.users.current.is_banned)return pages.unauth.banned();if(settings.users.current.user_level<1)return pages.news();document.title="yunNet. - "+settings.lang.getValue("management"),ui.isMobile()&&(nav_header_title.innerText=settings.lang.getValue("management"));let t,n=pages.elements.menuBody().clear(),s=pages.elements.buildRightMenu(),r=s.addItem(settings.lang.getValue("main"),function(){return ui.go("https://"+window.location.host+"/dev")}),a=s.addItem(settings.lang.getValue("bug_tracker"),function(){return ui.go("https://"+window.location.host+"/dev?section=bugs")});settings.users.current.user_level>3&&(t=s.addItem(settings.lang.getValue("files"),function(){return ui.go("https://"+window.location.host+"/dev?section=files")}));let l=new URLParser(window.location.href).parse().section||"main",i=["main","files","bugs"];if(-1===i.indexOf(l)&&(l="main"),l===i[0]){n.appendChild(pages.elements.createButton(unt.Icon.SETTINGS,settings.lang.getValue("your_access_level")+": <b>"+settings.users.current.user_level+"</b>",new Function));let e=document.createElement("div");n.appendChild(e),e.classList.add("card"),e.classList.add("full_section");let t=document.createElement("div");t.classList.add("valign-wrapper"),e.appendChild(t);let s=pages.elements.createInputField(settings.lang.getValue("short_link_or_id"),!1);s.style.width="100%",t.appendChild(s);let a=pages.elements.createFAB(unt.Icon.ARROW_FWD,function(){if(s.getValue().isEmpty())return;let e="",t=s.getValue().split("yunnet.ru/");return(e=t[1]?t[1]:t[0]).isEmpty()?void 0:(a.style.display="none",l.style.display="",settings.users.resolveScreenName(e).then(function(e){n.innerHTML="",n.appendChild(pages.elements.backArrowButton(settings.lang.getValue("back"),function(){return ui.go(window.location.href,!1,!0)}));let t=document.createElement("div");t.classList=["card full_section"],n.appendChild(t);let s=document.createElement("div");s.classList=["valign-wrapper"],t.appendChild(s);let r=document.createElement("div"),a=document.createElement("img");a.width=64,a.height=64,a.classList.add("circle"),a.alt="",r.appendChild(a),s.appendChild(r);let l=document.createElement("div");l.classList.add("halign-wrapper"),l.style.marginLeft="15px",s.appendChild(l);let i=document.createElement("div");i.classList.add("valign-wrapper"),l.appendChild(i);let o=document.createElement("b");i.appendChild(o),o.innerText=settings.lang.getValue("loading");let u=document.createElement("div");l.appendChild(u);let d=document.createElement("small");u.appendChild(d),d.innerText="...",e.photo_object?a.setAttribute("attachment","photo"+e.photo_object.owner_id+"_"+e.photo_object.id+"_"+e.photo_object.access_key):a.setAttribute("attachment","photo"+ui.userVisited+"_1_all"),a.onclick=function(){return photos.show(a,e.photo_object)},a.src=e.photo_url;let c=pages.parsers.getOnlineState(e);if(o.innerText="user"===e.account_type?e.first_name+" "+e.last_name:e.name,d.innerText=c,e.is_verified){let e=document.createElement("div");e.classList.add("credentials"),i.appendChild(e);let t=document.createElement("div");t.classList.add("card"),t.style.margin=0,t.style.cursor="pointer",t.style.width=t.style.height="20px",t.style.borderRadius="30px",t.innerHTML=unt.Icon.PALETTE_ANIM,e.appendChild(t)}let g=[];settings.users.current.user_level>=2&&g.push([unt.Icon.EDIT,settings.lang.getValue("user_edit"),function(){let t=document.createElement("div");t.classList.add("modal"),t.classList.add("bottom-sheet"),t.classList.add("unselectable"),t.addEventListener("dragstart",function(e){return e.preventDefault()}),t.addEventListener("dragend",function(e){return e.preventDefault()});let n=document.createElement("div");t.appendChild(n),n.classList.add("valign-wrapper"),n.style.width="100%";let s=document.createElement("div");n.appendChild(s),s.style.width="100%",n.style.padding="20px",s.innerText=settings.lang.getValue("user_edit");let r=document.createElement("div");r.style.cursor="pointer",r.style.marginTop="5px",n.appendChild(r),r.innerHTML=unt.Icon.CLOSE,r.addEventListener("click",function(){return unt.Modal.getInstance(t).close()}),t.open=function(){document.body.appendChild(t);let e=unt.Modal.init(t,{onCloseEnd:function(){return t.remove()}});return e&&e.open(),t.style.top=0,t.style.width=t.style.height="100%",t.style.borderRadius=0,!0};let a=document.createElement("div");t.appendChild(a);let l=document.createElement("img");l.addEventListener("click",function(){let t=pages.elements.fileUploader({onFileSelected:function(t,n,s){return s.setLoading(!0),uploads.getURL().then(function(t){return uploads.upload(t,n[0],function(e){return codes.callbacks.uploadResolve(e,s)}).then(function(t){let n="photo"+t.photo.owner_id+"_"+t.photo.id+"_"+t.photo.access_key;return management.users.actions.edit(e.user_id||-1*e.bot_id,{photo:n}).then(function(e){return s.setLoading(!1),l.src=e.photo.url.main,s.close()}).catch(function(e){return s.setLoading(!1),unt.toast({html:settings.lang.getValue("upload_error")})})}).catch(function(e){let t=settings.lang.getValue("upload_error");return unt.toast({html:t}),s.setLoading(!1)})}).catch(function(e){let t=settings.lang.getValue("upload_error");return unt.toast({html:t}),s.setLoading(!1)})},afterClose:function(){}});return t.addFooterItem(settings.lang.getValue("delete_a_photo"),function(n,s){return s.setLoading(!0),management.users.actions.edit(e.user_id||-1*e.bot_id,{photo:""}).then(function(e){return s.setLoading(!1),l.src="https://dev.yunnet.ru/images/default.png",t.close()}).catch(function(e){return t.setLoading(!1),unt.toast({html:settings.lang.getValue("upload_error")})})}),t.open()}),l.classList.add("circle"),l.height=l.width=72,l.src=e.photo_url,l.style.marginRight="15px",a.appendChild(l);let i,o,u,d=document.createElement("div");a.classList.add("valign-wrapper"),a.appendChild(d),d.style.width="100%",a.style.padding="20px","user"===e.account_type?(i=pages.elements.createInputField(settings.lang.getValue("first_name"),!0).setText(e.first_name).maxLength(64),o=pages.elements.createInputField(settings.lang.getValue("last_name"),!0).setText(e.last_name).maxLength(64),d.appendChild(i),d.appendChild(o)):(u=pages.elements.createInputField(settings.lang.getValue("bot_name"),!0).setText(e.name).maxLength(64),d.appendChild(u));let c=pages.elements.getLoader();c.classList.remove("center"),c.style.textAlign="end",c.style.display="none",d.appendChild(c);let g=pages.elements.createFAB(unt.Icon.SAVE,function(){c.style.display="",g.style.display="none",i&&i.getInput().setAttribute("disabled",!0),o&&o.getInput().setAttribute("disabled",!0),u&&u.getInput().setAttribute("disabled",!0);let t={};return i&&(t.first_name=i.getValue()),o&&(t.last_name=o.getValue()),u&&(t.name=u.getValue()),management.users.actions.edit(e.user_id||-1*e.bot_id,t).then(function(e){return c.style.display="none",g.style.display="",i&&i.getInput().removeAttribute("disabled"),o&&o.getInput().removeAttribute("disabled"),u&&u.getInput().removeAttribute("disabled"),unt.toast({html:settings.lang.getValue("saved")})}).catch(function(e){c.style.display="none",g.style.display="",i&&i.getInput().removeAttribute("disabled"),o&&o.getInput().removeAttribute("disabled"),u&&u.getInput().removeAttribute("disabled");let t=settings.lang.getValue("upload_error");return e.errorMessage&&(t=e.errorMessage),unt.toast({html:t})})});return g.style.textAlign="end",g.classList.remove("fixed-action-btn"),d.appendChild(g),t.open()}]),g.push([unt.Icon.SETTINGS,settings.lang.getValue("user_settings"),function(){let t=e.user_id||-1*e.bot_id;e.user_level||(e.user_level=0);let n=pages.elements.createWindow(),s=n.getContent(),r=[],a=[];(settings.users.current.user_level>e.user_level&&settings.users.current.user_level>=3||4===settings.users.current.user_level)&&settings.users.current.user_id!==e.user_id&&r.push([unt.Icon.DEV,settings.lang.getValue("banned"),function(n){return management.users.actions.banUser(t).then(function(t){e.is_banned=Number(t),l.selectItem(0,t)}).catch(function(t){return l.selectItem(0,Boolean(e.is_banned)),unt.toast({html:settings.lang.getValue("upload_error")})})},e.is_banned]),(settings.users.current.user_level>e.user_level&&settings.users.current.user_level>=1||4===settings.users.current.user_level)&&r.push([unt.Icon.PALETTE_ANIM,settings.lang.getValue("verified"),function(){return management.users.actions.toggleVerification(t).then(function(t){e.is_verified=Number(t),l.selectItem(1,t)}).catch(function(t){return l.selectItem(1,Boolean(e.is_verified)),unt.toast({html:settings.lang.getValue("upload_error")})})},e.is_verified]),e.online&&e.online&&(settings.users.current.user_level>e.user_level&&settings.users.current.user_level>=4||4===settings.users.current.user_level)&&a.push([unt.Icon.ACCOUNT,settings.lang.getValue("hidden_online"),function(n){return management.users.actions.toggleOnlineShow(t).then(function(t){e.online.hidden_online=!0,i.selectItem(0,t)}).catch(function(t){return i.selectItem(0,Boolean(e.online.hidden_online)),unt.toast({html:settings.lang.getValue("upload_error")})})},e.online.hidden_online]);let l=pages.elements.createSwitchButton(r),i=pages.elements.createSwitchButton(a);e.is_banned&&l.selectItem(0,!0),e.is_verified&&l.selectItem(1,!0),e.online&&e.online.hidden_online&&i.selectItem(0,!0),r.length>0&&s.appendChild(l),a.length>0&&s.appendChild(i),n.getFooter().remove()}]),n.appendChild(pages.elements.createButton(null,null,null,"black",g)),settings.users.current.user_level>3&&(e.user_level||0)<settings.users.current.user_level&&n.appendChild(pages.elements.createButton("",settings.lang.getValue("user_deletion"),function(){let t=(e.name?e.name:e.first_name+" "+e.last_name)+" "+getRandomInt(1e5,999999),n=pages.elements.confirm("",settings.lang.getValue("user_deletion_attention").replace("%username%",t),function(n,r,a,l){return n?s.getValue()!==t?s.getInput().classList.add("wrong"):(s.getInput().classList.remove("wrong"),management.users.delete(e.user_id||-1*e.bot_id).then(function(e){if(r.close(),e)return ui.go()}).catch(function(e){return unt.toast({html:settings.lang.getValue("upload_error")})})):r.close()},!1).getBody();n.classList.add("unselectable");let s=pages.elements.createInputField(settings.lang.getValue("confirm_deletion"),!1).setType("text");n.appendChild(s)},"red"))}).catch(function(e){return a.style.display="",l.style.display="none",unt.toast({html:settings.lang.getValue("upload_error")})}))});a.classList.remove("fixed-action-btn"),a.style.marginLeft="20px",t.appendChild(a);let l=pages.elements.getLoader();if(l.style.marginLeft="20px",t.appendChild(l),l.style.display="none",settings.users.current&&settings.users.current.user_level>=4)return management.actions.getSettings().then(function(e){let t=pages.elements.createSwitchButton([[unt.Icon.DEV,settings.lang.getValue("closed_project"),function(){return management.actions.toggleProjectClose().catch(function(e){return unt.toast({html:settings.lang.getValue("upload_error")})})}],[unt.Icon.ACCOUNT,settings.lang.getValue("closed_register"),function(){return management.actions.toggleRegisterClose().catch(function(e){return unt.toast({html:settings.lang.getValue("upload_error")})})}]]);t.selectItem(0,e.closed_project),t.selectItem(1,e.closed_register),n.appendChild(t)}).catch(function(e){});r.select()}if(l===i[1]){if(settings.users.current.user_level<3)return ui.go("https://"+window.location.host+"/dev");t.select();let e="/",s=pages.elements.backArrowButton(e,function(){let t=e.split("/");t.splice(t.length-1,1),t.splice(t.length-1,1),(e=t.join("/")+"/").isEmpty()&&(e="/"),o(e)});n.appendChild(s);let r=document.createElement("div");function o(t){s.style.display="/"===t?"none":"",s.setText(e),r.innerHTML="";let a=pages.elements.getLoader();r.appendChild(a);let l=new FormData;return l.append("action","show_project_files"),l.append("user_id",settings.users.current.user_id),l.append("file_path",t),ui.Request({url:"/dev",method:"POST",data:l,success:function(t){(t=JSON.parse(t)).error&&n.appendChild(pages.elements.uploadError()),t.response.forEach(function(t){let n=document.createElement("div");n.classList.add("card"),n.classList.add("collection-item"),n.classList.add("avatar");let s=document.createElement("i");s.classList.add("circle"),n.appendChild(s),n.appendChild(s),r.appendChild(n);let a=document.createElement("span");a.classList.add("title"),n.appendChild(a);let l=document.createElement("b");a.appendChild(l),l.innerText=t.name,n.onclick=function(){"directory"===t.type&&o(e+=t.name+"/")};let i=document.createElement("div");n.appendChild(i),i.innerText=t.type,n.style.cursor="pointer"}),r.style.display="",a.style.display="none"}})}r.classList.add("collection"),r.classList.add("card"),r.style.display="none",n.appendChild(r),o(e)}if(l===i[2]){if(settings.users.current.user_level<2)return ui.go("https://"+window.location.host+"/dev");a.select();let e=pages.elements.createTabs([[settings.lang.getValue("bugs_reported"),function(){}],[settings.lang.getValue("reports_list"),function(){}],[settings.lang.getValue("text_reports"),function(){}]]);n.appendChild(e)}s.append()}};